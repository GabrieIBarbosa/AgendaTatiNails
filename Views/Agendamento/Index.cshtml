@model IEnumerable<AgendaTatiNails.Models.Servico>
@{
    ViewData["Title"] = "Seu Agendamento";
    
    // Captura o ID pré-selecionado que veio do Controller (se houver)
    var preSelectedId = ViewBag.PreSelectedServiceId?.ToString() ?? "";
}

@section Styles {
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="~/css/Agendamento/agendamento-page.css" asp-append-version="true" />
}

<div class="agendamento-container" data-is-authenticated="@User.Identity.IsAuthenticated.ToString().ToLower()">
    <a href="/" class="btn-back">← Voltar para Serviços</a>
    <h1 class="page-title">Agendamento de Serviço</h1>

    <section id="step-calendario" class="agendamento-step active">
        <h2>1. Escolha o Serviço e a Data</h2>
        
        <div class="form-group-service">
            <label for="service-select">Serviço Desejado:</label>
            <select id="service-select" class="full-width-input">
                @if (Model != null && Model.Any())
                {
                    @foreach (var servico in Model)
                    {
                        <option value="@servico.ServicoId" 
                                data-price="@servico.ServicoPreco"
                                data-duration="@servico.ServicoDuracao"
                                data-name="@servico.ServicoDesc">
                            @servico.ServicoDesc (@servico.ServicoPreco.ToString("C"))
                        </option>
                    }
                }
                else
                {
                    <option value="">Nenhum serviço disponível.</option>
                }
            </select>
        </div>

        <div class="calendar-wrapper">
            <input type="date" id="calendar-date" min="@DateTime.Today.ToString("yyyy-MM-dd")" class="full-width-input" />
        </div>

        <p id="step-1-message" class="step-message-container"></p>

        <div class="step-actions">
            <button class="btn-primary" id="btnProximoHorarios">Próximo: Ver Horários</button>
        </div>
    </section>

    <section id="step-horarios" class="agendamento-step">
        <h2>2. Escolha o Horário</h2>
        <div class="horarios-grid" id="horariosGrid"></div>
        <p id="step-2-message" class="step-message-container"></p>
        <div class="step-actions">
            <button class="btn-secondary" id="btnVoltarCalendario">Voltar</button>
            <button class="btn-primary" id="btnProximoConfirmacao">Próximo: Confirmar</button>
        </div>
    </section>

    <section id="step-confirmacao" class="agendamento-step">
        <h2>3. Confirme seu Agendamento</h2>
        
        <div class="confirmation-summary">
            <p>Serviço: <span class="confirm-service"></span></p>
            <p>Data: <span class="confirm-date"></span></p>
            <p>Hora: <span class="confirm-time"></span></p>
            <p>Preço: <span class="confirm-price"></span></p>
        </div>

        <div class="form-group-obs" style="margin-top: 20px;">
            <label for="inputObservacao" style="display:block; font-weight:bold; margin-bottom: 5px;">Observações (Opcional):</label>
            <textarea id="inputObservacao" class="full-width-input" rows="3" 
                      placeholder="Ex: Tenho preferência pela cor vermelha, tenho alergia a..."></textarea>
        </div>

        <p id="step-3-message" class="step-message-container"></p>
        
        <div class="step-actions">
            <button class="btn-secondary" id="btnVoltarHorarios">Voltar</button>
            <button class="btn-primary" id="btnConfirmarAgendamento">Confirmar Agendamento</button>
        </div>
    </section>
</div>

@section Scripts {
    <script src="~/js/agendamento-page.js" asp-append-version="true"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Pega o ID que veio do Controller (ViewBag)
            var preSelectedId = "@preSelectedId";
            var select = document.getElementById("service-select");

            // Se tiver um ID e o select existir, seleciona e atualiza
            if(preSelectedId && select) {
                select.value = preSelectedId;
                
                // Dispara o evento 'change' para que o seu javascript principal (agendamento-page.js)
                // perceba a mudança, calcule o preço e a duração corretamente.
                select.dispatchEvent(new Event('change'));
            }
        });
    </script>
}