@model AgendaTatiNails.Models.ViewModels.EditarAgendamentoViewModel

@{
    ViewData["Title"] = "Editar Agendamento";
    
    // Pega os dados atuais que o Controller passou
    var dataAtual = Model.HorarioAtual.HorarioData.ToString("yyyy-MM-dd");
    var horarioIdAtual = Model.HorarioAtual.HorarioId;
    var horaAtualFormatada = Model.HorarioAtual.HorarioPeriodo.ToString(@"hh\:mm");
}

@section Styles {
    <link rel="stylesheet" href="~/css/Agendamento/agendamento-page.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Agendamento/crud-page.css" asp-append-version="true" />
}

<div class="crud-container">
    <div class="crud-card">

        <h1 class="crud-title">@ViewData["Title"]</h1>
        @if (TempData["MensagemErro"] != null)
{
    <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 15px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #f5c6cb;">
        <strong>Ocorreu um erro:</strong> @TempData["MensagemErro"]
    </div>
}

@if (TempData["MensagemSucesso"] != null)
{
    <div class="alert alert-success" style="background-color: #d4edda; color: #155724; padding: 15px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #c3e6cb;">
        @TempData["MensagemSucesso"]
    </div>
}
        <p class="crud-subtitle">Altere os dados do seu agendamento abaixo.</p>

        <div asp-validation-summary="ModelOnly" class="text-danger crud-message"></div>
        <p id="edit-message" class="step-message-container"></p>

        <form asp-action="Editar" method="post">
            @Html.AntiForgeryToken()
            
            <input type="hidden" asp-for="AtendimentoId" />

            <div class="form-group">
                <label asp-for="ServicoId" class="control-label">Serviço</label>
                <select asp-for="ServicoId" id="service-select" class="full-width-input" asp-items="Model.TodosOsServicos">
                    </select>
                <span asp-validation-for="ServicoId" class="text-danger"></span>
            </div>
            
            <div class="form-group">
                <label for="calendar-date">Data</label>
                <input id="calendar-date" class="full-width-input" type="date" 
                       value="@dataAtual" 
                       min="@DateTime.Today.ToString("yyyy-MM-dd")" />
            </div>

            <div class="form-group">
                <label asp-for="HorarioId" class="control-label">Horário</label>
                <select asp-for="HorarioId" id="horario-select" class="full-width-input">
                    <option value="">-- Selecione a data --</option>
                </select>
                <span asp-validation-for="HorarioId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary btn-full-width">Salvar Alterações</button>
            </div>
        </form>

        <div class="crud-links">
            <a asp-action="ListaServico" asp-controller="Servico">Cancelar e Voltar</a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Este script é quase idêntico ao 'agendamento-page.js'
            
            const dataInput = document.getElementById('calendar-date');
            const horaSelect = document.getElementById('horario-select');
            const servicoSelect = document.getElementById('service-select'); // Agora usamos o select
            const editMessage = document.getElementById('edit-message');
            
            // Pega os valores atuais que o Model (C#) passou para o HTML
            const atendimentoId = @Model.AtendimentoId;
            const dataAtual = "@dataAtual";
            const horarioIdAtual = @horarioIdAtual;
            const horaAtualFormatada = "@horaAtualFormatada";
            const servicosDuracao = @Html.Raw(ViewBag.ServicosDuracao);

            function showMessage(element, message, type = 'error') {
                if (element) {
                    element.textContent = message;
                    element.className = 'step-message-container active ' + type;
                }
            }

            async function buscarHorarios() {
        const dataSelecionada = dataInput.value;
        const optionSelecionada = servicoSelect.options[servicoSelect.selectedIndex];
        
        if (!dataSelecionada || !optionSelecionada) {
            horaSelect.innerHTML = '<option value="">-- Selecione serviço e data --</option>';
            return;
        }

        // --- MUDANÇA PRINCIPAL AQUI ---
        // Pega a duração do serviço selecionado no <select> usando o JSON auxiliar
        const servicoId = parseInt(servicoSelect.value);
        const servicoInfo = servicosDuracao.find(s => s.id === servicoId);
        // Se não achar (erro), usa 45 como padrão
        const duracaoTotal = servicoInfo ? servicoInfo.duracao : 45;
        // ------------------------------

        horaSelect.innerHTML = '<option value="">Buscando horários...</option>';
        horaSelect.disabled = true;
        if(editMessage) editMessage.classList.remove('active');

        try {
            // O Fetch agora envia a duração correta calculada acima
            const fetchUrl = `/Agendamento/GetHorariosDisponiveis?data=${dataSelecionada}&duracaoTotal=${duracaoTotal}`;
            const response = await fetch(fetchUrl);
            
            if (!response.ok) { throw new Error('Erro ao buscar horários.'); }
            
            const horariosDisponiveis = await response.json();
            horaSelect.innerHTML = ''; 
            let horaOriginalEncontradaNaLista = false;

            if (horariosDisponiveis.length === 0) {
                horaSelect.innerHTML = '<option value="">-- Nenhum horário --</option>';
            } else {
                horariosDisponiveis.forEach(h => {
                    const option = document.createElement('option');
                    option.value = h.horarioId; 
                    option.textContent = h.horario; 
                    
                    // Se este é o horário original E a data original, marca como (Atual)
                    if (dataSelecionada === dataAtual && h.horarioId === horarioIdAtual) {
                        option.textContent += " (Atual)";
                        horaOriginalEncontradaNaLista = true;
                    }
                    horaSelect.appendChild(option);
                });
            }
            
            // Adiciona o horário atual de volta à lista (se for a data atual)
            if (dataSelecionada === dataAtual && !horaOriginalEncontradaNaLista && horarioIdAtual > 0) {
                const optOriginal = document.createElement('option');
                optOriginal.value = horarioIdAtual;
                optOriginal.textContent = horaAtualFormatada + " (Atual - Mantido)";
                horaSelect.insertBefore(optOriginal, horaSelect.firstChild);
                horaOriginalEncontradaNaLista = true;
            }

            // Seleciona o horário
            if(horaOriginalEncontradaNaLista) {
                horaSelect.value = horarioIdAtual.toString();
            }
            
        } catch (error) {
            console.error("Erro ao buscar horários:", error);
            showMessage(editMessage, 'Erro de conexão ao buscar horários.');
            horaSelect.innerHTML = '<option value="">Erro</option>';
        } finally {
            horaSelect.disabled = false;
        }
    }

            // Gatilhos
            dataInput.addEventListener('change', buscarHorarios);
            servicoSelect.addEventListener('change', buscarHorarios);
            
            // Busca os horários assim que a página carrega
            buscarHorarios(); 
        });
    </script>
}