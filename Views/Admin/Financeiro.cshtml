@model IEnumerable<AgendaTatiNails.Models.Atendimento>
@using AgendaTatiNails.Models.ViewModels

@{
    ViewData["Title"] = "Relatório Financeiro";
    
    var faturamentoTotal = (decimal)(ViewBag.FaturamentoTotal ?? 0m);
    var totalServicos = (int)(ViewBag.TotalServicosConcluidos ?? 0);
    var faturamentoPorServico = (List<ServicoFaturadoViewModel>)(ViewBag.FaturamentoPorServico ?? new List<ServicoFaturadoViewModel>());

    // Datas para o filtro
    var dataInicio = ViewBag.DataInicio as DateTime? ?? DateTime.Today;
    var dataFim = ViewBag.DataFim as DateTime? ?? DateTime.Today;
}

@section Styles {
    <link rel="stylesheet" href="~/css/Admin/admin.css" asp-append-version="true" />
}

<div class="admin-container">
    <div class="admin-header">
        <h1>@ViewData["Title"]</h1>
        <span class="welcome-badge" style="background-color: #15803d;">@User.Identity.Name</span>
    </div>

    <form method="get" asp-action="Financeiro" class="admin-search-form">
        <div class="form-group">
            <label for="dataInicio">Data Início:</label>
            <input type="date" id="dataInicio" name="dataInicio" 
                   value="@dataInicio.ToString("yyyy-MM-dd")" 
                   class="form-control" />
        </div>

        <div class="form-group">
            <label for="dataFim">Data Fim:</label>
            <input type="date" id="dataFim" name="dataFim" 
                   value="@dataFim.ToString("yyyy-MM-dd")" 
                   class="form-control" />
        </div>

        <button type="submit" class="btn btn-primary">
            <i class="fa fa-filter me-2"></i> Filtrar
        </button>
    </form>

    <div class="stat-card-grid">
        <div class="stat-card">
            <div class="stat-card-icon icon-bg-green">
                <img src="https://api.iconify.design/lucide-dollar-sign.svg" alt="" />
            </div>
            <div class="stat-card-info">
                <span class="stat-card-value">@faturamentoTotal.ToString("C", new System.Globalization.CultureInfo("pt-BR"))</span>
                <span class="stat-card-label">Faturamento Total</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon icon-bg-purple">
                <img src="https://api.iconify.design/lucide-check-check.svg" alt="" />
            </div>
            <div class="stat-card-info">
                <span class="stat-card-value">@totalServicos</span>
                <span class="stat-card-label">Serviços no Período</span>
            </div>
        </div>
    </div>

    <h2 class="admin-subtitle">Resumo por Serviço (No Período)</h2>
    @if (faturamentoPorServico.Any())
    {
        <ul class="finance-breakdown-list">
            @foreach (var servico in faturamentoPorServico)
            {
                <li>
                    <div class="breakdown-service-name">
                        @servico.NomeServico
                        <span>(@servico.Quantidade x)</span>
                    </div>
                    <div class="breakdown-service-total">
                        @servico.ValorTotal.ToString("C", new System.Globalization.CultureInfo("pt-BR"))
                    </div>
                </li>
            }
        </ul>
    }
    else
    {
        <div class="text-center py-4 text-muted">
            <i class="fa fa-info-circle me-2"></i> Nenhum serviço concluído neste período.
        </div>
    }


    <h2 class="admin-subtitle">Histórico Detalhado</h2>
    @if (Model.Any())
    {
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Data Conclusão</th>
                        <th>Serviço(s)</th> 
                        <th>Valor (R$)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model) 
                    {
                        <tr>
                            <td class="client-name">@(item.Cliente?.Usuario?.UsuarioNome ?? "N/A")</td>
                            
                            <td>@(item.atendDataConclusao?.ToString("dd/MM/yyyy 'às' HH:mm") ?? item.AtendDataAtend.ToString("dd/MM/yyyy"))</td>
                            
                            <td>@(item.Servicos.Any() ? string.Join(", ", item.Servicos.Select(s => s.ServicoDesc)) : "N/A")</td>
                            
                            <td style="color: #15803d; font-weight: 500;">
                                @(item.AtendPrecoFinal?.ToString("C", new System.Globalization.CultureInfo("pt-BR")) ?? "R$ 0,00")
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="text-center mt-5 no-appointments">
            <img src="https://api.iconify.design/lucide-archive.svg" alt="Arquivo Vazio" class="no-appointments-icon" />
            <p class="lead">Nenhum registro financeiro para este filtro.</p>
        </div>
    }
</div>